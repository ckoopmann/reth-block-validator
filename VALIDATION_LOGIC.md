# Validation Logic
High level summary of the different steps in the Validation logic and comparison against [geth based implementation](https://github.com/ultrasoundmoney/builder/pull/1)

# Geth Logic
1. Parse ExecutionPayload into node representation of a Block ([function call](https://github.com/ultrasoundmoney/builder/blob/aa8f1a597901f303551b21d2bbf637dea1205624/eth/block-validation/api.go#L124), [definition](https://github.com/ultrasoundmoney/builder/blob/aa8f1a597901f303551b21d2bbf637dea1205624/beacon/engine/types.go#L276)
    1.  Decode Transactions ([call](https://github.com/ultrasoundmoney/builder/blob/aa8f1a597901f303551b21d2bbf637dea1205624/beacon/engine/types.go#L282), [implementation](https://github.com/ultrasoundmoney/builder/blob/aa8f1a597901f303551b21d2bbf637dea1205624/beacon/engine/types.go#L145)
    2.  Generate Withdrawal Hash ([implementation](https://github.com/ultrasoundmoney/builder/blob/aa8f1a597901f303551b21d2bbf637dea1205624/beacon/engine/types.go#L287-L296))
    3.  Combine Payload Data with decoded transactions and withdrawal hash into Block object ([implementation](https://github.com/ultrasoundmoney/builder/blob/aa8f1a597901f303551b21d2bbf637dea1205624/beacon/engine/types.go#L306-L324)
2. Verify Withdrawals (**commented out with reference of this being verified on the relay**: [call](https://github.com/ultrasoundmoney/builder/blob/aa8f1a597901f303551b21d2bbf637dea1205624/eth/block-validation/api.go#L129-L133))
3. Compare Block header (parsed from paylaod) with `Message` values. ([implementation](https://github.com/ultrasoundmoney/builder/blob/aa8f1a597901f303551b21d2bbf637dea1205624/eth/block-validation/api.go#L135-L150))
4. Validate Payload ([call](https://github.com/ultrasoundmoney/builder/blob/aa8f1a597901f303551b21d2bbf637dea1205624/eth/block-validation/api.go#L154))
    1. Verify Header ([call](https://github.com/ultrasoundmoney/builder/blob/aa8f1a597901f303551b21d2bbf637dea1205624/core/blockchain.go#L2499), [implementation](https://github.com/ultrasoundmoney/builder/blob/aa8f1a597901f303551b21d2bbf637dea1205624/consensus/beacon/consensus.go#L81))
        1. Check wether we are already in POS based on TTD (only analysing POS / post-merge flow from here on, [implementation](https://github.com/ultrasoundmoney/builder/blob/aa8f1a597901f303551b21d2bbf637dea1205624/consensus/beacon/consensus.go#L82-L95)
            1. Check if parent block is known ([implementation](https://github.com/ultrasoundmoney/builder/blob/aa8f1a597901f303551b21d2bbf637dea1205624/consensus/beacon/consensus.go#L90-L93))
            1. Verify Header POS ([call](https://github.com/ultrasoundmoney/builder/blob/aa8f1a597901f303551b21d2bbf637dea1205624/consensus/beacon/consensus.go#L95))
                1. Check if "extra data" is > 32 bytes ([implementation](https://github.com/ultrasoundmoney/builder/blob/aa8f1a597901f303551b21d2bbf637dea1205624/consensus/beacon/consensus.go#L229-L231))
                2. Check that Nonce is not equal to the default value ([implementation](https://github.com/ultrasoundmoney/builder/blob/aa8f1a597901f303551b21d2bbf637dea1205624/consensus/beacon/consensus.go#L233-L235))
                3. Check that UncleHash is not empty ([implementation](https://github.com/ultrasoundmoney/builder/blob/aa8f1a597901f303551b21d2bbf637dea1205624/consensus/beacon/consensus.go#L236-L238))
                4. Verify that `BlockTime >= Parent.BlockTime` ([implementation](https://github.com/ultrasoundmoney/builder/blob/aa8f1a597901f303551b21d2bbf637dea1205624/consensus/beacon/consensus.go#L239-L242))
                5. Verify that Difficulty is equal to "BeaconDifficulty" ([implementation](https://github.com/ultrasoundmoney/builder/blob/aa8f1a597901f303551b21d2bbf637dea1205624/consensus/beacon/consensus.go#L244-L246))
                6. Verify that the gas limit is less than the theoretical maximum (2^63-1) ([implementation](https://github.com/ultrasoundmoney/builder/blob/aa8f1a597901f303551b21d2bbf637dea1205624/consensus/beacon/consensus.go#L247))
                7. Verify that gas used is less than gas limit ([implementation](https://github.com/ultrasoundmoney/builder/blob/aa8f1a597901f303551b21d2bbf637dea1205624/consensus/beacon/consensus.go#L251))
                8. Verify that block number is one more than parents block number ([implementation](https://github.com/ultrasoundmoney/builder/blob/aa8f1a597901f303551b21d2bbf637dea1205624/consensus/beacon/consensus.go#L255-L258))
                9. Verify BaseFee is set correctly according to EIP1559 specifications ([call]([call](https://github.com/ultrasoundmoney/builder/blob/aa8f1a597901f303551b21d2bbf637dea1205624/consensus/beacon/consensus.go#L260), [implementation](https://github.com/ultrasoundmoney/builder/blob/aa8f1a597901f303551b21d2bbf637dea1205624/consensus/misc/eip1559.go#L32-L52))
                10. Verify that withdrawals hash is set when withdrawals are active([implementation](https://github.com/ultrasoundmoney/builder/blob/aa8f1a597901f303551b21d2bbf637dea1205624/consensus/beacon/consensus.go#L263-L270))
    2. Check for reorg ([implementation](https://github.com/ultrasoundmoney/builder/blob/aa8f1a597901f303551b21d2bbf637dea1205624/core/blockchain.go#L2503-L2507))
    3. Check that gas limit is correct with respect to the value set by the Validator ([call](https://github.com/ultrasoundmoney/builder/blob/aa8f1a597901f303551b21d2bbf637dea1205624/core/blockchain.go#L2514-L2518))
    4. Apply / Process all transactions in Block ([call](https://github.com/ultrasoundmoney/builder/blob/aa8f1a597901f303551b21d2bbf637dea1205624/core/blockchain.go#L2532-L2535), [implementation](https://github.com/ultrasoundmoney/builder/blob/aa8f1a597901f303551b21d2bbf637dea1205624/core/state_processor.go#L59))
    5. Check that withdrawals are present if active ([implementation](https://github.com/ultrasoundmoney/builder/blob/aa8f1a597901f303551b21d2bbf637dea1205624/core/blockchain.go#L2537-L2550))
    6. "Validate Body" [call](https://github.com/ultrasoundmoney/builder/blob/aa8f1a597901f303551b21d2bbf637dea1205624/core/blockchain.go#L2551), [implementation](https://github.com/ultrasoundmoney/builder/blob/aa8f1a597901f303551b21d2bbf637dea1205624/core/block_validator.go#L53)
        1. Check that block is not already known ([implementation](https://github.com/ultrasoundmoney/builder/blob/aa8f1a597901f303551b21d2bbf637dea1205624/core/block_validator.go#L54-L57))
        2. Check that uncle/-hash is set correctly (uncles should be empty in POS)([implementation](https://github.com/ultrasoundmoney/builder/blob/aa8f1a597901f303551b21d2bbf637dea1205624/core/block_validator.go#L61-L67)
        3. Calculate tx hash from block and verify it against the given header ([implementation](https://github.com/ultrasoundmoney/builder/blob/aa8f1a597901f303551b21d2bbf637dea1205624/core/block_validator.go#L68-L70)
        4. Calcualte and compare withdrawals hash ([implementation](https://github.com/ultrasoundmoney/builder/blob/aa8f1a597901f303551b21d2bbf637dea1205624/core/block_validator.go#L71-L84))
        5. Check for parent block with number and hash and verify that it present and not "pruned" (TODO: check what the latter implies) ([implementation](https://github.com/ultrasoundmoney/builder/blob/aa8f1a597901f303551b21d2bbf637dea1205624/core/block_validator.go#L85-L90))
    7. "Validate State" ([call](https://github.com/ultrasoundmoney/builder/blob/aa8f1a597901f303551b21d2bbf637dea1205624/core/blockchain.go#L2555), [implementation](https://github.com/ultrasoundmoney/builder/blob/aa8f1a597901f303551b21d2bbf637dea1205624/core/block_validator.go#L96)
        1. Check that gasUsed calculated from transaction simulation is equal to the header value ([implementation](https://github.com/ultrasoundmoney/builder/blob/aa8f1a597901f303551b21d2bbf637dea1205624/core/block_validator.go#L98-L100))
        2. Calculate and compare receipts "bloom" (TODO: What is this ? ) ([implementation]( https://github.com/ultrasoundmoney/builder/blob/aa8f1a597901f303551b21d2bbf637dea1205624/core/block_validator.go#L103-L106)
        3. Calculate and compare receipts hash / root (TODO: make sure those are the same ? ) ([implementation](https://github.com/ultrasoundmoney/builder/blob/aa8f1a597901f303551b21d2bbf637dea1205624/core/block_validator.go#L107-L111))
        4. Compare StateRoot (this seems to be the equivalent to the step that takes 70ms on our side - TODO: Compare implementations) ([implementation](https://github.com/ultrasoundmoney/builder/blob/aa8f1a597901f303551b21d2bbf637dea1205624/core/block_validator.go#L114-L116))
    8. Verfiy Proposer Payment (TODO: There are a few additional checks regarding malformed proposer payment - Check if we need this too) ([implementation](https://github.com/ultrasoundmoney/builder/blob/aa8f1a597901f303551b21d2bbf637dea1205624/core/blockchain.go#L2559-L2612))

# Reth Logic
1. Check that gas limit is correct with respect to the value set by the Validator ([call](https://github.com/ckoopmann/reth-block-validator/blob/f632700f71db16f3797152dcf9fe309cde72afce/src/rpc/validation.rs#L78), [implementation](https://github.com/ckoopmann/reth-block-validator/blob/f632700f71db16f3797152dcf9fe309cde72afce/src/rpc/validation.rs#L224-L245))
2. Compare Execution Payload with `Message` values. ([call](https://github.com/ckoopmann/reth-block-validator/blob/f632700f71db16f3797152dcf9fe309cde72afce/src/rpc/validation.rs#L81), [implementation](https://github.com/ckoopmann/reth-block-validator/blob/f632700f71db16f3797152dcf9fe309cde72afce/src/rpc/validation.rs#L122))
3. Parse ExecutionPayload into node representation of a Block ([call](https://github.com/ckoopmann/reth-block-validator/blob/f632700f71db16f3797152dcf9fe309cde72afce/src/rpc/validation.rs#L85)), which includes:
    1. Check if "extra data" is > 32 bytes ([implementation](https://github.com/paradigmxyz/reth/blob/9fe3b02c2133ee27e79e0c9bfea92b174891bb81/crates/rpc/rpc-types-compat/src/engine/payload.rs#L15))
    1. Check that base_fee_per_gas is >= minimum value of 7 ([implementation](https://github.com/paradigmxyz/reth/blob/9fe3b02c2133ee27e79e0c9bfea92b174891bb81/crates/rpc/rpc-types-compat/src/engine/payload.rs#L19))
    1. Decoding Transactions and calculating root([implementation](https://github.com/paradigmxyz/reth/blob/9fe3b02c2133ee27e79e0c9bfea92b174891bb81/crates/rpc/rpc-types-compat/src/engine/payload.rs#L23))
    1. Calculating withdrawals root ([implementation](https://github.com/paradigmxyz/reth/blob/9fe3b02c2133ee27e79e0c9bfea92b174891bb81/crates/rpc/rpc-types-compat/src/engine/payload.rs#L72))
1. Use reth built in "full_validation" method to do various validations ([call](https://github.com/ckoopmann/reth-block-validator/blob/f632700f71db16f3797152dcf9fe309cde72afce/src/rpc/validation.rs#L87)) - includes:
    1. Verify Header (standalone):
        1. Check that `gasUsed <= gasLimit` ([implementation](https://github.com/paradigmxyz/reth/blob/9fe3b02c2133ee27e79e0c9bfea92b174891bb81/crates/consensus/common/src/validation.rs#L22))
        2. Check that baseFee is set ([implementation](https://github.com/paradigmxyz/reth/blob/9fe3b02c2133ee27e79e0c9bfea92b174891bb81/crates/consensus/common/src/validation.rs#L30))
        3. Check that withdrawals root is set ([implementation](https://github.com/paradigmxyz/reth/blob/9fe3b02c2133ee27e79e0c9bfea92b174891bb81/crates/consensus/common/src/validation.rs#L38))
        4. Check that EIP-4844 data is (not) set based on wether Cancun is active ([implementation](https://github.com/paradigmxyz/reth/blob/9fe3b02c2133ee27e79e0c9bfea92b174891bb81/crates/consensus/common/src/validation.rs#L49)
   1. Verify Block (standalone):
        1. Check that Ommers hash is set correctly ([implementation](https://github.com/paradigmxyz/reth/blob/9fe3b02c2133ee27e79e0c9bfea92b174891bb81/crates/consensus/common/src/validation.rs#L206))
        2. Check that transactions_root is correct (probably don't need this because we generated this from the trnasactions in the first place / TODO: Make sure that we actually verify that changing the transactions root in the payload leads to failure) ([implementation](https://github.com/paradigmxyz/reth/blob/9fe3b02c2133ee27e79e0c9bfea92b174891bb81/crates/consensus/common/src/validation.rs#L214))
        3. Check that withdrawals root is correct (see above) ([implementation](https://github.com/paradigmxyz/reth/blob/9fe3b02c2133ee27e79e0c9bfea92b174891bb81/crates/consensus/common/src/validation.rs#L222))
        4. Check that blob gas is correct (inactive until Cancun)([implementation](https://github.com/paradigmxyz/reth/blob/9fe3b02c2133ee27e79e0c9bfea92b174891bb81/crates/consensus/common/src/validation.rs#L239))
    1. Validate Block (regarding chain):
        1. Check that block is not already known (only checking for hash / what if block with this number is already known ?)([implementation](https://github.com/paradigmxyz/reth/blob/9fe3b02c2133ee27e79e0c9bfea92b174891bb81/crates/consensus/common/src/validation.rs#L373))
        2. Check that parent block is known (Only checking for hash / what if parent is known but it is not the current tip (i.e. `parent.block_number != block_number - 1`)([implementation](https://github.com/paradigmxyz/reth/blob/9fe3b02c2133ee27e79e0c9bfea92b174891bb81/crates/consensus/common/src/validation.rs#L378))
    1. Validate Header (regarding parent):
        1. Check that `parent.block_number == block_number - 1`([implemntation](https://github.com/paradigmxyz/reth/blob/9fe3b02c2133ee27e79e0c9bfea92b174891bb81/crates/consensus/common/src/validation.rs#L294))
        2. Check that `parent.hash = block.parent_hash`. (probably not necessary since we retrieved the parent block using the hash)([implementation](https://github.com/paradigmxyz/reth/blob/9fe3b02c2133ee27e79e0c9bfea92b174891bb81/crates/consensus/common/src/validation.rs#L301)
        3. Check that timestamp did not decrease ([implementation](https://github.com/paradigmxyz/reth/blob/9fe3b02c2133ee27e79e0c9bfea92b174891bb81/crates/consensus/common/src/validation.rs#L308))
        4. Check gas_limit calculation with respect to its parent (probably unnecessary since this check is duplicated by our check which also takes proposer configured limit into consideration) ([implementation](https://github.com/paradigmxyz/reth/blob/9fe3b02c2133ee27e79e0c9bfea92b174891bb81/crates/consensus/common/src/validation.rs#L256))
        5. Check that base fee is calculated correctly ([implementation](https://github.com/paradigmxyz/reth/blob/9fe3b02c2133ee27e79e0c9bfea92b174891bb81/crates/consensus/common/src/validation.rs#L331C1-L331C1))
        6. EIP-4844 header validation (currently inactive) ([implementation](https://github.com/paradigmxyz/reth/blob/9fe3b02c2133ee27e79e0c9bfea92b174891bb81/crates/consensus/common/src/validation.rs#L353))
    1. EC-Recover sender addresses from tx signatures ([implementation](https://github.com/paradigmxyz/reth/blob/9fe3b02c2133ee27e79e0c9bfea92b174891bb81/crates/consensus/common/src/validation.rs#L398))
    1. Validate transactions. Does the following for each tx:
        1. Validate Transaction regarding header:
            1. Check that transaction does not contain fields that are not applicable at the current hardfork (EIP-155: chain_id, 2930: access list, 1559: priority_gas_fee)([implementation](https://github.com/paradigmxyz/reth/blob/9fe3b02c2133ee27e79e0c9bfea92b174891bb81/crates/consensus/common/src/validation.rs#L72))
            1. Check that priority_gas_fee is not higher than max_gas_fee ([implementation](https://github.com/paradigmxyz/reth/blob/9fe3b02c2133ee27e79e0c9bfea92b174891bb81/crates/consensus/common/src/validation.rs#L115))
            1. Check that chain_id is set correctly ([implementation](https://github.com/paradigmxyz/reth/blob/9fe3b02c2133ee27e79e0c9bfea92b174891bb81/crates/consensus/common/src/validation.rs#L125))
            1. Check that `max_fee >= base_fee`: ([implementation](https://github.com/paradigmxyz/reth/blob/9fe3b02c2133ee27e79e0c9bfea92b174891bb81/crates/consensus/common/src/validation.rs#L132))
        1. Check that signer account does not have bytecode (VERIFY: probably not necessary since there is no way to sign a transaction with a smart contract account)([implementation](https://github.com/paradigmxyz/reth/blob/9fe3b02c2133ee27e79e0c9bfea92b174891bb81/crates/consensus/common/src/validation.rs#L174)
        2. Check that nonce is correct ([implementation](https://github.com/paradigmxyz/reth/blob/9fe3b02c2133ee27e79e0c9bfea92b174891bb81/crates/consensus/common/src/validation.rs#L187))
        

