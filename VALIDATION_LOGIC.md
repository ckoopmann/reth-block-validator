# Validation Logic
High level summary of the different steps in the Validation logic and comparison against [geth based implementation](https://github.com/ultrasoundmoney/builder/pull/1)

# Geth Logic
1. Parse ExecutionPayload into node representation of a Block ([function call](https://github.com/ultrasoundmoney/builder/blob/aa8f1a597901f303551b21d2bbf637dea1205624/eth/block-validation/api.go#L124), [definition](https://github.com/ultrasoundmoney/builder/blob/aa8f1a597901f303551b21d2bbf637dea1205624/beacon/engine/types.go#L276)
    1.  Decode Transactions ([call](https://github.com/ultrasoundmoney/builder/blob/aa8f1a597901f303551b21d2bbf637dea1205624/beacon/engine/types.go#L282), [implementation](https://github.com/ultrasoundmoney/builder/blob/aa8f1a597901f303551b21d2bbf637dea1205624/beacon/engine/types.go#L145)
    2.  Generate Withdrawal Hash ([implementation](https://github.com/ultrasoundmoney/builder/blob/aa8f1a597901f303551b21d2bbf637dea1205624/beacon/engine/types.go#L287-L296))
    3.  Combine Payload Data with decoded transactions and withdrawal hash into Block object ([implementation](https://github.com/ultrasoundmoney/builder/blob/aa8f1a597901f303551b21d2bbf637dea1205624/beacon/engine/types.go#L306-L324)
2. Verify Withdrawals (**commented out with reference of this being verified on the relay**: [call](https://github.com/ultrasoundmoney/builder/blob/aa8f1a597901f303551b21d2bbf637dea1205624/eth/block-validation/api.go#L129-L133))
3. Compare Block header (parsed from paylaod) with `Message` values. ([implementation](https://github.com/ultrasoundmoney/builder/blob/aa8f1a597901f303551b21d2bbf637dea1205624/eth/block-validation/api.go#L135-L150))
4. Validate Payload ([call](https://github.com/ultrasoundmoney/builder/blob/aa8f1a597901f303551b21d2bbf637dea1205624/eth/block-validation/api.go#L154))
    1. Verify Header ([call](https://github.com/ultrasoundmoney/builder/blob/aa8f1a597901f303551b21d2bbf637dea1205624/core/blockchain.go#L2499), [implementation](https://github.com/ultrasoundmoney/builder/blob/aa8f1a597901f303551b21d2bbf637dea1205624/consensus/beacon/consensus.go#L81))
        1. Check wether we are already in POS based on TTD (only analysing POS / post-merge flow from here on, [implementation](https://github.com/ultrasoundmoney/builder/blob/aa8f1a597901f303551b21d2bbf637dea1205624/consensus/beacon/consensus.go#L82-L95)
            1. Check if parent block is known ([implementation](https://github.com/ultrasoundmoney/builder/blob/aa8f1a597901f303551b21d2bbf637dea1205624/consensus/beacon/consensus.go#L90-L93))
            1. Verify Header POS ([call](https://github.com/ultrasoundmoney/builder/blob/aa8f1a597901f303551b21d2bbf637dea1205624/consensus/beacon/consensus.go#L95))
                1. Check if "extra data" is > 32 bytes ([implementation](https://github.com/ultrasoundmoney/builder/blob/aa8f1a597901f303551b21d2bbf637dea1205624/consensus/beacon/consensus.go#L229-L231))
                2. Check that Nonce is not equal to the default value ([implementation](https://github.com/ultrasoundmoney/builder/blob/aa8f1a597901f303551b21d2bbf637dea1205624/consensus/beacon/consensus.go#L233-L235))
                3. Check that UncleHash is not empty ([implementation](https://github.com/ultrasoundmoney/builder/blob/aa8f1a597901f303551b21d2bbf637dea1205624/consensus/beacon/consensus.go#L236-L238))
                4. Verify that `BlockTime >= Parent.BlockTime` ([implementation](https://github.com/ultrasoundmoney/builder/blob/aa8f1a597901f303551b21d2bbf637dea1205624/consensus/beacon/consensus.go#L239-L242))
                5. Verify that Difficulty is equal to "BeaconDifficulty" ([implementation](https://github.com/ultrasoundmoney/builder/blob/aa8f1a597901f303551b21d2bbf637dea1205624/consensus/beacon/consensus.go#L244-L246))
                6. Verify that the gas limit is less than the theoretical maximum (2^63-1) ([implementation](https://github.com/ultrasoundmoney/builder/blob/aa8f1a597901f303551b21d2bbf637dea1205624/consensus/beacon/consensus.go#L247))
                7. Verify that gas used is less than gas limit ([implementation](https://github.com/ultrasoundmoney/builder/blob/aa8f1a597901f303551b21d2bbf637dea1205624/consensus/beacon/consensus.go#L251))
                8. Verify that block number is one more than parents block number ([implementation](https://github.com/ultrasoundmoney/builder/blob/aa8f1a597901f303551b21d2bbf637dea1205624/consensus/beacon/consensus.go#L255-L258))
                9. Verify BaseFee is set correctly according to EIP1559 specifications ([call]([call](https://github.com/ultrasoundmoney/builder/blob/aa8f1a597901f303551b21d2bbf637dea1205624/consensus/beacon/consensus.go#L260), [implementation](https://github.com/ultrasoundmoney/builder/blob/aa8f1a597901f303551b21d2bbf637dea1205624/consensus/misc/eip1559.go#L32-L52))
                10. Verify that withdrawals hash is set when withdrawals are active([implementation](https://github.com/ultrasoundmoney/builder/blob/aa8f1a597901f303551b21d2bbf637dea1205624/consensus/beacon/consensus.go#L263-L270))
    2. Check for reorg ([implementation](https://github.com/ultrasoundmoney/builder/blob/aa8f1a597901f303551b21d2bbf637dea1205624/core/blockchain.go#L2503-L2507))
    3. Check that gas limit is correct with respect to the value set by the Validator ([call](https://github.com/ultrasoundmoney/builder/blob/aa8f1a597901f303551b21d2bbf637dea1205624/core/blockchain.go#L2514-L2518))
    4. Apply / Process all transactions in Block ([call](https://github.com/ultrasoundmoney/builder/blob/aa8f1a597901f303551b21d2bbf637dea1205624/core/blockchain.go#L2532-L2535)[implementation](https://github.com/ultrasoundmoney/builder/blob/aa8f1a597901f303551b21d2bbf637dea1205624/core/state_processor.go#L59))
    5. Check that withdrawals are present if active ([implementation](https://github.com/ultrasoundmoney/builder/blob/aa8f1a597901f303551b21d2bbf637dea1205624/core/blockchain.go#L2537-L2550))
    6. "Validate Body" [call](https://github.com/ultrasoundmoney/builder/blob/aa8f1a597901f303551b21d2bbf637dea1205624/core/blockchain.go#L2551), [implementation](https://github.com/ultrasoundmoney/builder/blob/aa8f1a597901f303551b21d2bbf637dea1205624/core/block_validator.go#L53)
        1. Check that block is not already known ([implementation](https://github.com/ultrasoundmoney/builder/blob/aa8f1a597901f303551b21d2bbf637dea1205624/core/block_validator.go#L54-L57))
        2. Check that uncle/-hash is set correctly (uncles should be empty in POS)([implementation](https://github.com/ultrasoundmoney/builder/blob/aa8f1a597901f303551b21d2bbf637dea1205624/core/block_validator.go#L61-L67)
        3. Calculate tx hash from block and verify it against the given header ([implementation](https://github.com/ultrasoundmoney/builder/blob/aa8f1a597901f303551b21d2bbf637dea1205624/core/block_validator.go#L68-L70)
        4. Calcualte and compare withdrawals hash ([implementation](https://github.com/ultrasoundmoney/builder/blob/aa8f1a597901f303551b21d2bbf637dea1205624/core/block_validator.go#L71-L84))
        5. Check for parent block with number and hash and verify that it present and not "pruned" (TODO: check what the latter implies) ([implementation](https://github.com/ultrasoundmoney/builder/blob/aa8f1a597901f303551b21d2bbf637dea1205624/core/block_validator.go#L85-L90))
    7. "Validate State" ([call](https://github.com/ultrasoundmoney/builder/blob/aa8f1a597901f303551b21d2bbf637dea1205624/core/blockchain.go#L2555), [implementation](https://github.com/ultrasoundmoney/builder/blob/aa8f1a597901f303551b21d2bbf637dea1205624/core/block_validator.go#L96)
        1. Check that gasUsed calculated from transaction simulation is equal to the header value ([implementation](https://github.com/ultrasoundmoney/builder/blob/aa8f1a597901f303551b21d2bbf637dea1205624/core/block_validator.go#L98-L100))
        2. Calculate and compare receipts "bloom" (TODO: What is this ? ) ([implementation]( https://github.com/ultrasoundmoney/builder/blob/aa8f1a597901f303551b21d2bbf637dea1205624/core/block_validator.go#L103-L106)
        3. Calculate and compare receipts hash / root (TODO: make sure those are the same ? ) ([implementation](https://github.com/ultrasoundmoney/builder/blob/aa8f1a597901f303551b21d2bbf637dea1205624/core/block_validator.go#L107-L111))
        4. Compare StateRoot (this seems to be the equivalent to the step that takes 70ms on our side - TODO: Compare implementations) ([implementation](https://github.com/ultrasoundmoney/builder/blob/aa8f1a597901f303551b21d2bbf637dea1205624/core/block_validator.go#L114-L116))
    8. Verfiy Proposer Payment (TODO: There are a few additional checks regarding malformed proposer payment - Check if we need this too) ([implementation](https://github.com/ultrasoundmoney/builder/blob/aa8f1a597901f303551b21d2bbf637dea1205624/core/blockchain.go#L2559-L2612)

